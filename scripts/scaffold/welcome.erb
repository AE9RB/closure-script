<% 
require 'fileutils'

source_dir = File.expand_path File.dirname(__FILE__)
dest_dir = Dir.getwd
begin
  Dir.chdir source_dir 
  all_files = Dir.glob '**/*.*'
ensure
  Dir.chdir dest_dir
end
all_files -= %w{
  welcome.erb
  hello/compiler.map
  hello/compiler.debug
  hello/compiler.build
  hello/legume.js
}

conflict = false
all_files.each do |file|
  conflict = true if File.exist? File.join dest_dir, file
  break if conflict
end

if post? and !conflict
  all_files.each do |file|
    FileUtils.mkdir_p File.dirname File.join dest_dir, file
    File.open(File.join(dest_dir, file), 'w') do |f|
      f.write File.read File.join source_dir, file
    end
  end
  #TODO http://closure-library.googlecode.com/svn/trunk/
  render 'svn', :svn_name => 'Closure Library', :svn_path => 'closure-library',
      :svn_url => 'file:///Users/dturnbull/closure-library-repo/trunk', :svn_update => 'HEAD'
  response.redirect path
end

if get? -%>
<!DOCTYPE html>
<html>
  <head>
    <meta name="Content-Type" content="text/html; charset=UTF-8" />
    <title>Welcome to Closure</title>
  </head>
  <body>
    <h1>Welcome to Closure</h1>
    
    <dl>
    <dt>Running in:</dt>
    <dd><%=h dest_dir %></dd>
    </dl>
    
    <% if !conflict %>
      <form action='?' method="post">
        Prepare this folder?
        <input type="submit" value="Write Scaffold" onclick="return this.disabled=true" />
      </form>
    <% else %>
      <span style="color:red">ERROR:</span>
      Existing files prevent scaffold install.
    <% end %>
    
  </body>
</html>
<% end -%>
